<!DOCTYPE html>
<html style="height: 100%">
<head>
	<title></title>
</head>
<body style="height: 100%;background: black">
	<div id="myCanvas" style="position: absolute; height:100%;width:100%">
	</div>
    <script type="text/javascript" src="../../dist/i2d.js"></script>

	<script type="text/javascript">

    var img = new Image();
        img.src = 'vlanIcon.svg'
        img.onload = function(){
            var im = document.createElement('canvas');
            var ctx = im.getContext("2d");
             im.setAttribute('height', this.height * 2);
            im.setAttribute('width', this.width * 2);
            im.style['height'] = this.height + 'px';
            im.style['width'] = this.width + 'px';
            ctx.drawImage(this,0,0,100,100);
            onImageLoad(im)
        }

    function onImageLoad(imageData){

    

        // var renderer3 = i2d._2DCanvasLayer('#myCanvas',{events:false,selectiveClear:false});
        var renderer2 = i2d.CanvasLayer('#myCanvas',{events:true,selectiveClear:false});
        var renderer = i2d.CanvasLayer('#myCanvas',{events:true,selectiveClear:false});
        
        
        var width = 1400,height=900;
        var circles,links;

        var radius = 150;

        var data2 = [{	
				sub:[1,2,3,4,5],
				value:6
			},
			{	
				sub:[1,2,8],
				value:3
			},
            {	
				sub:[1,2,8,9],
				value:4
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2,3],
				value:3
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[1,2],
				value:2
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			},
            {	
				sub:[],
				value:0
			}
			];
            data2 = data2.sort(function(b,a){return a.value - b.value});

        var pieData = pieAngleLayout(data2);
       
        var g = renderer.createEl({
                    el:'group',
                    attr:{
                        transform:{
                            translate:[700,450]
                        }
                    }
                });
        
        var g2 = renderer2.createEl({
                    el:'group',
                    attr:{
                        transform:{
                            translate:[700,450]
                        }
                    }
                });

            g2.createEl({
                el:'image',
                attr:{
                    width:90,
                    height:100,
                    x:-45,
                    y:-50,
                    src:'adcIcon.svg'
                }
            });

            g.createEls(pieData,{
                    el:'group'
                })
            .forEach(function(d){
                var pathG = this.createEl({el:'group',attr:{class:'pathG'}});
                var nodeG = this.createEl({el:'group',attr:{class:'nodeG'}});

                g2.createEl({el:'path',
                                    attr:{
                                        d:pathGenerator(d,radius+d.level*50,radius+d.level*50-20)
                                    },
                                    styles:{
                                        fillStyle:'#fc4e2a',
                                        globalAlpha:0.3
                                    }
                                })
                                .on('mouseover',function(){
                                    this.setStyle('fillStyle','#19ceff')
                                    this.animateTo({
                                                    duration:100,ease:'easeInCubic',styles:{ globalAlpha:1 }
                                                });
                                })
                                .on('mouseout',function(){
                                    if(this.expanded)
                                        return;
                                    this.setStyle('fillStyle','#fc4e2a')
                                    this.animateTo({
                                                    duration:100,ease:'easeOutCubic',styles:{ globalAlpha:0.3 }
                                                });
                                })
                                .on('click',function(){
                                    var self = this;
                                    if(this.expanded){
                                        
                                        d.data.sub.forEach(function(_,i){
                                            nodeG.fetchElements('.tempNode'+i)
                                                                .animateTo({
                                                                            duration:500,
                                                                            ease:'easeInOutCubic',
                                                                            styles:{
                                                                                globalAlpha:0
                                                                            },
                                                                            end:function(){
                                                                                this.remove();
                                                                            }
                                                                });
                                            
                                            pathG.fetchElements('.tempPath'+i)
                                                                .animateTo({
                                                                            duration:1500,
                                                                            ease:'easeInOutCubic',
                                                                            styles:{
                                                                                lineDashOffset:function(){
                                                                                        console.log(this.node().getTotalLength());
                                                                                    return this.node().getTotalLength();
                                                                                }
                                                                            }
                                                                })
                                        });
                                        nodeG.fetchElements('text').remove();
                                        this.expanded = false;
                                    }else{
                                    this.setStyle('fillStyle','#19ceff')
                                    this.expanded = true;
                                    d.data.sub.forEach(function(_,i){
                                        var temp = computePathAngles(d,radius+i*30+d.level*50,radius+d.level*50,i);
                                        var startAngle = d.startAngle-Math.PI/2;
                                        var endAngle = d.endAngle-Math.PI/2;

                                        var midAngle = startAngle + (endAngle - startAngle)/2;
                                        var centroid = {x:(130+d.level*50)*Math.cos(midAngle),y:(130+d.level*50)*Math.sin(midAngle)};
                                        var ctrl1 = {x:(250+d.level*50)*Math.cos(midAngle),y:(250+d.level*50)*Math.sin(midAngle)};

                                        pathG.join(temp,'.tempPath'+i,{
                                                                joinCond:function(d,i){ return i; },
                                                                action:{
                                                                    new:function(data){
                                                                        this.createEls(data,{
                                                                                    el:'path',
                                                                                    attr:{
                                                                                        class:'tempPath'+i,
                                                                                        d:function(d) {
                                                                                            return 'M'+centroid.x+','+centroid.y + ' Q'+ctrl1.x+','+ctrl1.y +' '+ d.x+','+d.y;
                                                                                        }
                                                                                    },
                                                                                    styles:{
                                                                                        strokeStyle:'#19ceff',
                                                                                        globalAlpha:0.2,
                                                                                        setLineDash:function(){
                                                                                            var totalLength = this.node().getTotalLength();
                                                                                                if(isNaN(totalLength)){
                                                                                                    totalLength = 0;
                                                                                                }
                                                                                                return [totalLength,totalLength];
                                                                                        },
                                                                                        lineDashOffset:function(){
                                                                                            var totalLength = this.node().getTotalLength();
                                                                                                console.log(totalLength);
                                                                                            return totalLength
                                                                                        }
                                                                                    }
                                                                                })
                                                                                // .animatePathTo({
                                                                                //     duration:1500,
                                                                                //     ease:'easeInOutCubic'
                                                                                // });
                                                                    },
                                                                    old:function(oldNodes,oldData){
                                                                        oldNodes.remove();
                                                                    }
                                                                }
                                        })
                                        .animateTo({
                                                    duration:1500,
                                                    ease:'easeInOutCubic',
                                                    delay:(d.data.sub.length - 1 - i)*30,
                                                    styles:{
                                                        lineDashOffset:0
                                                    }
                                        });

                                        nodeG.join(temp,'.tempNode'+i,{
                                                                joinCond:function(d,i){ return i; },
                                                                action:{
                                                                    new:function(data){
                                                                        this.createEls(data,{
                                                                                    el:'image',
                                                                                    attr:{
                                                                                        class:'tempNode'+i,
                                                                                        width:0,
                                                                                        height:0,
                                                                                        x:0,
                                                                                        y:0,
                                                                                        src:'vlanIcon.png'
                                                                                    }
                                                                                })
                                                                                .on('mouseover',function(){
                                                                                    this.animateTo({
                                                                                        duration:100,
                                                                                        attr:{
                                                                                            transform:{
                                                                                                scale:[2]
                                                                                            }
                                                                                        }
                                                                                    })
                                                                                })
                                                                                .on('mouseout',function(){
                                                                                    this.animateTo({
                                                                                        duration:100,
                                                                                        attr:{
                                                                                            transform:{
                                                                                                scale:[1]
                                                                                            }
                                                                                        }
                                                                                    })
                                                                                })
                                                                                .animateTo({
                                                                                    duration:1500,
                                                                                    ease:'easeInOutCubic',
                                                                                    delay:(d.data.sub.length - 1 - i)*30,
                                                                                    attr:{
                                                                                        width:20,
                                                                                        height:20,
                                                                                        x:-20/2,
                                                                                        y:-20/2,
                                                                                        transform:function(d){
                                                                                            return function(t){
                                                                                                var point = bezierTransition(centroid,ctrl1,d,t);
                                                                                                return {
                                                                                                    translate:[point.x,point.y]
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    // styles:{
                                                                                    //     globalAlpha:1
                                                                                    // }
                                                                                });

                                                                                this.createEls(data,{
                                                                                    el:'text',
                                                                                    attr:{
                                                                                        x:function(d){return d.x-8},
                                                                                        y:function(d){return d.y-12}
                                                                                    },
                                                                                    styles:{
                                                                                        font:'6pt Calibri',
                                                                                        fillStyle:'#d4d4d4',
                                                                                        globalAlpha:0
                                                                                    }
                                                                                })
                                                                                .text('1234')
                                                                                .animateTo({
                                                                                    duration:1500,
                                                                                    ease:'easeInOutCubic',
                                                                                    delay:1500,
                                                                                    styles:{
                                                                                        globalAlpha:1
                                                                                    }
                                                                                });
                                                                    },
                                                                    old:function(oldNodes,oldData){
                                                                        oldNodes.remove();
                                                                    }
                                                                }
                                            });




                                    })

                                }

                            });
                
                

            })

         function pieAngleLayout(data){
                var div = data.length > 6?6:data.length;

            var multiArray = [];
            
            var sum = 0;
            var anglePerValue;
            var angle = 0;
            var nextRow = false;
                
                data.forEach(function(d,i){
                    
                    if(parseInt(i/div) === 0){
                        if(!multiArray[~~(i/div)])
                            multiArray[~~(i/div)] = [];
                        multiArray[~~(i/div)].push(d); 
                        sum += (d.value <=0?1:d.value);

                        anglePerValue = (2*Math.PI)/sum;
                        nextRow = true;
                    }
                    else{
                        if((nextRow) || (angle+(d.value <=0?1:d.value)*anglePerValue > 2*Math.PI)){
                            multiArray[multiArray.length] = [];
                            angle = 0;
                            nextRow = false;
                        }
                        multiArray[multiArray.length-1].push(d);
                        angle += (d.value <=0?1:d.value)*anglePerValue;
                    }

                })
                console.log(multiArray);
            
            var returArray = [];
            
            
                multiArray.forEach(function(d,i){

                    var conti = 0;
                    // var sum = d.reduce(function(p,_){ return p+(_.value <=0?1:_.value) },0);

                        returArray = returArray.concat(d.map(function(_,j){
                            

                            var obj = {};
                                _.value = _.value <=0?1:_.value;
                                obj.data = _;
                                obj.startAngle = conti;
                                obj.endAngle = conti+ anglePerValue*_.value;
                                obj.level = i;
                                conti = obj.endAngle;

                                return obj;
                        }))
                });


            return returArray;
            }

        function  pathGenerator(d,r,r2) {

           var startAngle = (d.startAngle-Math.PI/2 + 0.1)%(Math.PI*2);
            var endAngle = (d.endAngle-Math.PI/2 - 0.1)%(Math.PI*2);
            var diffAngle = endAngle - startAngle ; 
                diffAngle = diffAngle/2;
                
                diffAngle = (diffAngle < 0.2 && diffAngle >= 0)?diffAngle:diffAngle-0.2;
                diffAngle = diffAngle < 0?0:diffAngle;

            return 'M'+r*Math.cos(startAngle)+' '+r*Math.sin(startAngle) +
                        ' A'+r+' '+r+' 0 0 1 '+r*Math.cos(endAngle)+' '+r*Math.sin(endAngle) +
                        ' L'+r2*Math.cos(endAngle)+' '+r2*Math.sin(endAngle) +
                        ' A'+r2+' '+r2+' 0 0 0 '+r2*Math.cos(endAngle - diffAngle )+' '+r2*Math.sin(endAngle - diffAngle) +
                        // ' A'+(r2-r2*0.8)+' '+(r2-r2*0.8)+' 0 0 1 '+r2*Math.cos(startAngle + diffAngle*0.3)+' '+r2*Math.sin(startAngle + diffAngle*0.3) +
                        ' A'+(r-100)+' '+(r-100)+' 0 0 1 '+r2*Math.cos(startAngle + diffAngle)+' '+r2*Math.sin(startAngle + diffAngle) +
                        ' A'+r2+' '+r2+' 0 0 0 '+r2*Math.cos(startAngle)+' '+r2*Math.sin(startAngle) +'z'
        }

        function computePathAngles(angle,r,radius,level){

            var startAngle = angle.startAngle-Math.PI/2;
            var endAngle = angle.endAngle-Math.PI/2;

            var midAngle = startAngle + (endAngle - startAngle)/2;
                // console.log(angle)
            var p = {};
            var angleDev = ((endAngle - startAngle)/2)*0.5;
            var spreadAngle = Math.PI/(25)*-1;
            var spreadRadius = r+(endAngle - startAngle)*150;
            var segRa = (level+1)*30

                p.p0 = {x:(r+segRa)*Math.cos(midAngle+angleDev),y:(r+segRa)*Math.sin(midAngle+angleDev)},
                p.p1 = {x:(r+segRa)*Math.cos(midAngle-angleDev),y:(r+segRa)*Math.sin(midAngle-angleDev)};
                p.cntrl1 = {x:spreadRadius*Math.cos(midAngle+angleDev+spreadAngle),y:spreadRadius*Math.sin(midAngle+angleDev+spreadAngle)},
                p.cntrl2 = {x:spreadRadius*Math.cos(midAngle-angleDev-spreadAngle),y:spreadRadius*Math.sin(midAngle-angleDev-spreadAngle)};

            var co = cubicBezierCoefficients(p);
            var len = cubicBezierLength(p.p0,co);

            var points = [];
            var factor = 1/(~~(len/40));
            var f = 0
                while(f<=1){
                    points.push(cubicBezierTransition(p.p0,co,f));
                    f +=factor;
                }

            return points

        }

        function cubicBezierTransition(p0, co, f) {
            var p3 = Math.pow(f, 3),
                p2 = Math.pow(f, 2);
            return {
                x: co.ax * p3 + co.bx * p2 + co.cx * f + p0.x,
                y: co.ay * p3 + co.by * p2 + co.cy * f + p0.y
            }
        }

        function bezierTransition(p0, p1, p2, f) {
            return {
                x: (p0.x - 2 * p1.x + p2.x) * f * f + (2 * p1.x - 2 * p0.x) * f + p0.x,
                y: (p0.y - 2 * p1.y + p2.y) * f * f + (2 * p1.y - 2 * p0.y) * f + p0.y
            }
        }

        function cubicBezierLength(p0, co) {
            var interval = 0.001,
                sum = 0;

            var cubicBezierTransitionInstance = cubicBezierTransition.bind(null, p0, co);
            var p1, p2;
            for (var i = 0; i <= 1; i += interval) {
                p1 = cubicBezierTransitionInstance(i);
                p2 = cubicBezierTransitionInstance(i + interval);
                sum += Math.sqrt(Math.pow((p2.x - p1.x) / interval, 2) + (Math.pow((p2.y - p1.y) / interval, 2))) * interval;
            }
            return sum;
        };

        function cubicBezierCoefficients(p) {
            var cx = 3 * (p.cntrl1.x - p.p0.x),
                bx = 3 * (p.cntrl2.x - p.cntrl1.x) - cx,
                ax = p.p1.x - p.p0.x - cx - bx,
                cy = 3 * (p.cntrl1.y - p.p0.y),
                by = 3 * (p.cntrl2.y - p.cntrl1.y) - cy,
                ay = p.p1.y - p.p0.y - cy - by;

            return {
                cx: cx,
                bx: bx,
                ax: ax,
                cy: cy,
                by: by,
                ay: ay
            }
        }

    }

	</script>

</body>
</html>